# Development Dockerfile
# Используется для контейнера app в docker-compose.yml
# ВСЁ ИСПОЛНЕНИЕ КОДА ПРОИСХОДИТ ЗДЕСЬ, НЕ НА ХОСТЕ!

# Используем Alpine latest для совместимости с Prisma 7.x (требует Node 20.19+)
FROM node:20-alpine

# Устанавливаем необходимые системные зависимости
RUN apk add --no-cache \
    git \
    openssh \
    python3 \
    make \
    g++ \
    curl \
    openssl-dev

# Создаём рабочую директорию
WORKDIR /app

# Копируем все package.json файлы для установки зависимостей
COPY package*.json ./
COPY pnpm-lock.yaml ./
COPY pnpm-workspace.yaml ./
COPY packages/ ./packages/
COPY services/ ./services/
COPY apps/ ./apps/

# Устанавливаем глобальные инструменты
RUN npm install -g pnpm turbo prisma@6.19.0

# Устанавливаем зависимости проекта
RUN pnpm install

# Устанавливаем tsx глобально и добавляем в PATH
RUN npm install -g tsx

# Обновляем PATH для включения глобальных модулей npm
ENV PATH="/usr/local/bin:${PATH}"

# Expose порты
EXPOSE 3000 4000

# По умолчанию запускаем bash для интерактивной работы
# Реальная команда будет переопределена в docker-compose.yml
CMD ["sh"]

