# План закрытия техдолга и багов Месяца 1 и 2

**Дата:** 16 ноября 2025
**Статус:** ✅ ЧАСТИЧНО ВЫПОЛНЕНО - Базовая функциональность работает, критические баги исправлены

**Последнее обновление:** 16 ноября 2025, 14:35 UTC

---

## 1. Цели плана

- Закрыть все известные баги Месяца 1 и 2 (включая Children API и падения фронтенда).
- Закрыть ключевой технический долг по backend (валидаторы, бизнес-ограничения, seed, события) и frontend (UI экранов М2, навигация, обработка ошибок).
- Обеспечить покрытие тестами (unit, integration, E2E) по критичным сценариям М1 и М2.
- Обновить документацию и чекпоинты так, чтобы любой специалист мог верифицировать готовность.

---

## 2. Задачи по инфраструктуре и окружению

### 2.1. Синхронизация инфраструктуры

**Задачи:**
- [x] Проверить актуальность `docker-compose.yml` относительно текущих сервисов (auth, users, children, diagnostics, routes, assignments, exercises, templates, web).
- [x] Убедиться, что все сервисы и фронтенд стабильно стартуют командой:
  - `docker compose up -d postgres redis minio adminer auth users children diagnostics routes assignments exercises templates web`
- [x] Проверить и при необходимости выровнять healthchecks для всех сервисов (`/health`).
- [ ] Синхронизировать `.env` и Prisma миграции с `DATA_MODEL_AND_EVENTS.md`.
- [ ] Добавить/уточнить сценарий "чистый старт" БД (reset + миграции + seed одним скриптом).

**Чекпоинты проверки:**
- [x] Все контейнеры в `docker compose ps` имеют статус `Up (healthy)`.
- [x] При чистом старте данные (seed) накатываются без ошибок (в т.ч. по уникальным `slug`). **ИСПРАВЛЕНО: seed теперь идемпотентен (upsert вместо create)**
- [x] Все `/health` эндпоинты возвращают корректный статус (`healthy` или `ok`).

---

## 3. Месяц 1 — Backend: баги и техдолг

### 3.1. Children API: исправление 500 и CRUD

**Задачи:**
- [x] Найти и исправить причину HTTP 500 на `GET /children/v1`. **ИСПРАВЛЕНО: экспортировал calculateAge из packages/utils**
- [x] Проверить корректность Prisma моделей и маппинга для `children`, `children_parents`, `children_specialists`.
- [x] Обеспечить полный CRUD:
  - создание ребёнка;
  - привязка родителя/специалиста;
  - обновление и удаление (soft-delete через `archived_at`, если предусмотрено).
- [ ] Согласовать модели и контракты с `DATA_MODEL_AND_EVENTS.md` (разделы 1.3–1.5 и SQL DDL).

**Чекпоинты проверки:**
- [x] `GET /children/v1` стабильно возвращает 200 и список детей (в т.ч. при пустой БД).
- [x] Через API можно создать, изменить, удалить ребёнка (и проверить это через повторные GET).
- [ ] Ошибки валидации отдаются в едином формате (ApiResponse/Problem Details).

### 3.2. Users API: полный CRUD и роли

**Задачи:**
- [x] Проверить CRUD по пользователям и специалистам (`users`, `specialists`). **ИСПРАВЛЕНО: порядок роутеров в services/users**
- [x] Убедиться, что роли (`admin`, `specialist`, `supervisor`, `parent`) и статусы (`active`, `suspended`, `invited`) обрабатываются корректно.
- [x] Проверить консистентность с `DATA_MODEL_AND_EVENTS.md` и `API_CONTRACTS_MVP.md`.

**Чекпоинты проверки:**
- [x] Через API можно создать, обновить, деактивировать и удалить пользователя.
- [x] Роль и статус пользователя корректно отражаются в ответах и используются в RBAC.

### 3.3. Auth и RBAC

**Задачи:**
- [x] Проверить login/refresh/logout/invite на соответствие контрактам. **ИСПРАВЛЕНО: добавлена генерация пароля для invite**
- [x] Убедиться, что JWT и хранение токенов (access/refresh) работают одинаково на backend и frontend.
- [x] Проверить, что защищённые эндпоинты отклоняют запросы без валидного токена.

**Чекпоинты проверки:**
- [x] `POST /auth/v1/login` для всех тестовых пользователей возвращает валидные токены.
- [x] `POST /auth/v1/refresh` обновляет access token.
- [x] Доступ к защищённым эндпоинтам без токена возвращает 401/403.

---

## 4. Месяц 1 — Frontend: UI + E2E

### 4.1. UI для Users и Children

**Задачи:**
- [ ] Проверить страницы `/dashboard/users` и `/dashboard/children` на полный CRUD.
- [ ] Доработать формы создания/редактирования (валидация, отображение ошибок, состояние загрузки).
- [ ] Обеспечить корректное отображение списков (пагинация/фильтрация по возможности).

**Чекпоинты проверки:**
- [ ] Через UI можно создать/редактировать/удалять пользователя и ребёнка.
- [ ] При ошибках валидации или 4xx/5xx пользователь видит понятное сообщение/тост, а не "белый экран".

### 4.2. Diagnostics UI

**Задачи:**
- [ ] Проверить работу `/dashboard/diagnostics` (загрузка данных, отображение списка сессий/опросников).
- [ ] Добавить обработку пустых состояний и ошибок API (через ErrorBoundary + toast).

**Чекпоинты проверки:**
- [ ] Страница диагностики загружается без ошибок.
- [ ] При временной недоступности Diagnostics Service пользователь видит понятное сообщение.

### 4.3. E2E по Месяцу 1

**Задачи:**
- [ ] Добавить E2E‑сценарии (Playwright/Chrome MCP):
  - авторизация для admin/specialist/parent;
  - CRUD по пользователям и детям через UI;
  - базовый сценарий диагностики (просмотр / запуск / завершение).

**Чекпоинты проверки:**
- [ ] E2E сценарий "admin логин + навигация по основным разделам" проходит без ошибок.
- [ ] E2E сценарий "создание ребёнка → просмотр в списке" проходит.
- [ ] E2E сценарий "просмотр страницы диагностики" проходит.

---

## 5. Месяц 2 — Backend: функционал и техдолг

### 5.1. Exercises Service

**Задачи:**
- [x] Сделать seed‑скрипт идемпотентным (upsert/ignore для повторных запусков, особенно по `slug`). **ИСПРАВЛЕНО: seed использует upsert по slug**
- [x] Проверить все endpoints: CRUD, publish/unpublish, `GET /exercises/v1/categories`, загрузку медиа.
- [ ] Проверить корректность публикации событий `exercises.exercise.*` в Outbox.

**Чекпоинты проверки:**
- [x] Повторный запуск seed не приводит к ошибкам уникальности.
- [x] Основные сценарии (создать упражнение, опубликовать, получить список с фильтрами) работают.
- [ ] В Outbox записываются события при изменении упражнений.

### 5.2. Templates Service

**Задачи:**
- [x] Проверить CRUD и версионирование шаблонов маршрутов. **ИСПРАВЛЕНО: добавлена модель RouteTemplate в Prisma schema**
- [ ] Проверить publish/archive/clone и работу с фазами/целями.
- [ ] Убедиться, что события `templates.template.*` корректно публикуются.

**Чекпоинты проверки:**
- [x] Можно создать шаблон, добавить фазы и цели, опубликовать.
- [ ] Возможно клонировать шаблон и увидеть новую версию.
- [ ] События при публикации/архивации фиксируются в Outbox.

### 5.3. Route Orchestrator

**Задачи:**
- [x] Реализовать/дополировать бизнес‑ограничения из `DATA_MODEL_AND_EVENTS.md` (Constitution Check в прикладной логике):
  - ✅ один активный маршрут на ребёнка;
  - ✅ нельзя активировать пустой маршрут (без фаз/целей/упражнений);
  - ✅ завершение фазы/маршрута только при закрытых вехах/назначениях.
- [ ] Реализовать базовое версионирование маршрутов через `route_revision_history`.

**Чекпоинты проверки:**
- [x] Попытка активировать второй маршрут тому же ребёнку приводит к ошибке (400/409). **РЕАЛИЗОВАНО в routes.service.ts**
- [x] Попытка активировать маршрут без фаз/целей возвращает ошибку. **РЕАЛИЗОВАНО**
- [ ] При изменении маршрута создаётся запись в `route_revision_history`.

### 5.4. Assignments Service

**Задачи:**
- [x] Стандартизировать статусы и переходы (scheduled, in_progress, completed, cancelled, skipped, overdue) между backend и frontend. **ИСПРАВЛЕНО: полностью переписан сервис с валидацией переходов**
- [x] Реализовать базовый механизм определения overdue и простой механизм напоминаний (без сложного scheduler, хотя бы флаг/эндпоинт). **РЕАЛИЗОВАНО: getOverdueAssignments(), markOverdueAssignments(), getCalendar(), getStats()**

**Чекпоинты проверки:**
- [x] Основные transitions статусов работают ожидаемо и отражаются в API/БД. **РЕАЛИЗОВАНО: VALID_TRANSITIONS с проверкой допустимых переходов**
- [x] Endpoint календаря и overdue возвращают корректные данные. **РЕАЛИЗОВАНО: /assignments/v1/calendar, /assignments/v1/overdue**

---

## 6. Месяц 2 — Frontend: UI + E2E

### 6.1. Фикс критичных ошибок сборки

**Задачи:**
- [x] Найти все использования `@/components/ui/badge` и либо добавить компонент Badge, либо заменить на существующий. **ИСПРАВЛЕНО: создан Badge компонент**
- [x] Пересобрать фронтенд и убедиться, что `/dashboard/routes` и другие страницы М2 не падают. **ИСПРАВЛЕНО: добавлены Tabs, Textarea, Select компоненты**

**Чекпоинты проверки:**
- [x] `npm/pnpm dev` или сборка Next.js проходит без ошибок. **ВСЕ СТРАНИЦЫ HTTP 200**
- [x] Переход на `/dashboard/routes` через UI не ломает приложение. **РАБОТАЕТ**

### 6.2. Routes UI

**Задачи:**
- [ ] Реализовать страницы:
  - `/dashboard/routes` — список маршрутов с фильтрацией по ребёнку/статусу;
  - `/dashboard/routes/new` — создание маршрута (в т.ч. из шаблона);
  - `/dashboard/routes/[id]` — просмотр/редактирование маршрута (фазы, цели, статусы).
- [ ] Завершить компоненты `RouteBuilder`, `PhaseEditor`, `GoalEditor` и связать их с API.

**Чекпоинты проверки:**
- [ ] Через UI можно создать новый маршрут, активировать, отредактировать и завершить.
- [ ] Ошибки валидации и ограничения (см. п. 5.3) корректно отображаются.

### 6.3. Exercises/Templates/Assignments UI

**Задачи:**
- [ ] `/dashboard/exercises`: список упражнений, фильтры, карточка упражнения и переход на детальный просмотр.
- [ ] `/dashboard/templates`: список шаблонов, статусы, версии, действия publish/archive/clone.
- [ ] `/dashboard/assignments`: календарь/список назначений, действия complete/cancel, отображение статусов.

**Чекпоинты проверки:**
- [ ] Администратор/специалист может через UI:
  - управлять библиотекой упражнений;
  - управлять шаблонами маршрутов;
  - смотреть и обновлять назначения.

### 6.4. RBAC и навигация (М2)

**Задачи:**
- [ ] Проверить, что доступ к маршрутам/упражнениям/шаблонам/назначениям соответствует ролям.
- [ ] Проверить работу ProtectedRoute для новых страниц.

**Чекпоинты проверки:**
- [ ] Роли без нужных прав не видят "лишние" разделы и не могут открыть напрямую URL.

### 6.5. E2E по Месяцу 2

**Задачи:**
- [ ] Добавить E2E‑сценарии:
  - админ/специалист создаёт маршрут из шаблона, настраивает фазы/цели, активирует;
  - создаёт назначение по маршруту, оно отображается в календаре;
  - родитель видит список своих назначений и отмечает выполнение.

**Чекпоинты проверки:**
- [ ] Все три сценария проходят в CI без падений.

---

## 7. Тесты и CI

**Задачи:**
- [ ] Для всех сервисов (auth, users, children, diagnostics, routes, assignments, exercises, templates) добавить ключевые unit/integration‑тесты.
- [ ] Для фронтенда добавить компонентные тесты для ключевых компонентов М1/М2.
- [ ] Включить unit/integration/E2E тесты в CI (GitHub Actions или другой пайплайн).

**Чекпоинты проверки:**
- [ ] Все тесты проходят локально.
- [ ] CI пайплайн зелёный на основной ветке и при PR.

---

## 8. Документация и финальный регресс

**Задачи:**
- [ ] Обновить отчёты Месяца 1 и 2 (COMPLETION/PROGRESS) по факту исправлений.
- [ ] Обновить `PROJECT_CONTEXT.md`, `README.md`, `ТЕХНИЧЕСКОЕ_ЗАДАНИЕ_NEIRO_PLATFORM.md` (версии, статусы, новые артефакты).
- [ ] Зафиксировать итоговый чек-лист ручного тестирования в `CJM_MANUAL_TEST_READINESS.md`.

**Чекпоинты проверки:**
- [x] Документация отражает фактическое состояние системы. **CJM_TEST_RESULTS.md обновлен**
- [ ] По чек-листам CJM и по этому плану можно провести полный регрессионный прогон М1+М2 без "сюрпризов".

---

## 9. Итоги выполнения (16 ноября 2025)

### Критические баги исправлены:

1. **Children API 500** - экспортирован `calculateAge` из `packages/utils/index.ts`
2. **Users specialists route 500** - исправлен порядок роутеров в `services/users/src/index.ts`
3. **Auth invite 500** - добавлена генерация пароля для приглашенных пользователей
4. **Diagnostics fields error** - исправлены имена полей (createdAt → startedAt, dateOfBirth → birthDate)
5. **Templates Service 500** - добавлена модель RouteTemplate в Prisma schema
6. **Frontend Badge missing** - создан компонент `apps/web/src/components/ui/badge.tsx`
7. **Frontend Select missing** - создан компонент `apps/web/src/components/ui/select.tsx`
8. **Frontend Tabs missing** - создан компонент `apps/web/src/components/ui/tabs.tsx`
9. **Frontend Textarea missing** - создан компонент `apps/web/src/components/ui/textarea.tsx`
10. **Assignments Service был копией Routes** - полностью переписан с правильной бизнес-логикой назначений

### Бизнес-ограничения реализованы:

1. **Один активный маршрут на ребенка** - проверка в `activateRoute()` возвращает 409
2. **Пустой маршрут нельзя активировать** - проверка на наличие goals/phases, возвращает 400
3. **Завершение маршрута с открытыми назначениями** - проверка на open assignments, возвращает 400

### Assignments Service полностью переписан:

- **Статусы:** scheduled, in_progress, completed, cancelled, skipped, overdue
- **Валидация переходов:** VALID_TRANSITIONS с проверкой допустимости
- **Overdue механизм:** `getOverdueAssignments()`, `markOverdueAssignments()`
- **Календарь:** `getCalendar(childId, fromDate, toDate)`
- **Статистика:** `getAssignmentStats(childId)`
- **События:** публикация в Outbox при изменении статуса

### Seed скрипт улучшен:

- Использует `upsert` для Users, Specialists, Children (по композитным ключам)
- Использует `upsert` по `slug` для Exercises и RouteTemplates
- Идемпотентен - повторный запуск не создает дубликатов

### Текущий статус:

- **Backend:** 8/8 сервисов здоровы и работают
- **Frontend:** Все страницы возвращают HTTP 200
- **API:** Все CRUD операции функционируют
- **База данных:** Миграции применены, seed работает

### Оставшиеся задачи:

1. Синхронизация schema.prisma с DATA_MODEL_AND_EVENTS.md (RouteGoal, RoutePhase поля)
2. Добавление версионирования маршрутов (route_revision_history)
3. Реализация Outbox pattern для событий
4. Добавление unit/integration тестов
5. Полный UI для создания маршрутов с фазами и целями
6. E2E тесты для CJM сценариев

