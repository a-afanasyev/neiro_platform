// Prisma Schema для Neiro Platform
// Версия: 0.1.0
// Основано на DATA_MODEL_AND_EVENTS.md v0.4

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// USERS & AUTHENTICATION
// ============================================================

/// Пользователи системы
/// Все роли: parent, specialist, supervisor, admin
model User {
  id         String   @id @default(uuid()) @db.Uuid
  firstName  String   @map("first_name") @db.VarChar(100)
  lastName   String   @map("last_name") @db.VarChar(100)
  email      String   @unique @db.VarChar(255)
  /// Хешированный пароль (bcrypt)
  password   String   @db.VarChar(255)
  phone      String?  @db.VarChar(50)
  externalId String?  @unique @map("external_id") @db.VarChar(100)
  /// Роль: parent, specialist, supervisor, admin
  role       String   @db.VarChar(20)
  /// Статус: active, suspended, invited
  status     String   @default("invited") @db.VarChar(20)
  timezone   String   @default("UTC") @db.VarChar(50)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  specialist      Specialist?
  childrenParents ChildParent[]
  assignedBy      Assignment[]        @relation("AssignedBy")
  reports         Report[]            @relation("ParentReports")
  diagnostics     DiagnosticSession[] @relation("PerformedBy")

  @@index([email])
  @@index([role, status])
  @@map("users")
}

/// Профили специалистов (нейропсихологи, логопеды и т.д.)
model Specialist {
  id                String    @id @default(uuid()) @db.Uuid
  userId            String    @unique @map("user_id") @db.Uuid
  /// Специализация: neuropsychologist, speech_therapist, aba, occupational, supervisor, other
  specialty         String    @db.VarChar(50)
  licenseNumber     String?   @map("license_number") @db.VarChar(100)
  licenseValidUntil DateTime? @map("license_valid_until") @db.Date
  experienceYears   Int?      @map("experience_years")
  bio               String?   @db.Text
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  childrenSpecialists ChildSpecialist[]
  leadRoutes          Route[]           @relation("LeadSpecialist")
  assignments         Assignment[]      @relation("SpecialistAssignments")

  @@map("specialist")
}

// ============================================================
// CHILDREN & FAMILIES
// ============================================================

/// Профили детей с РАС
model Child {
  id               String    @id @default(uuid()) @db.Uuid
  firstName        String    @map("first_name") @db.VarChar(100)
  lastName         String    @map("last_name") @db.VarChar(100)
  birthDate        DateTime  @map("birth_date") @db.Date
  gender           String?   @db.VarChar(20)
  diagnosisSummary String?   @map("diagnosis_summary") @db.Text
  notes            String?   @db.Text
  archivedAt       DateTime? @map("archived_at") @db.Timestamptz(6)
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  parents     ChildParent[]
  specialists ChildSpecialist[]
  diagnostics DiagnosticSession[]
  routes      Route[]
  assignments Assignment[]

  @@map("child")
}

/// Связь ребенок - родитель (M:N)
model ChildParent {
  id               String    @id @default(uuid()) @db.Uuid
  childId          String    @map("child_id") @db.Uuid
  parentUserId     String    @map("parent_user_id") @db.Uuid
  legalGuardian    Boolean   @default(false) @map("legal_guardian")
  /// Тип родства: mother, father, guardian, other
  relationship     String    @db.VarChar(50)
  guardianshipType String?   @map("guardianship_type") @db.VarChar(50)
  invitedAt        DateTime? @map("invited_at") @db.Timestamptz(6)
  linkedAt         DateTime? @map("linked_at") @db.Timestamptz(6)

  // Relations
  child  Child @relation(fields: [childId], references: [id], onDelete: Cascade)
  parent User  @relation(fields: [parentUserId], references: [id], onDelete: Cascade)

  @@unique([childId, parentUserId])
  @@map("children_parents")
}

/// Связь ребенок - специалист (команда специалистов)
model ChildSpecialist {
  id              String    @id @default(uuid()) @db.Uuid
  childId         String    @map("child_id") @db.Uuid
  specialistId    String    @map("specialist_id") @db.Uuid
  /// Специализация в команде: lead, speech, aba, occupational, supervisor, other
  specialization  String    @db.VarChar(50)
  isPrimary       Boolean   @default(false) @map("is_primary")
  assignedAt      DateTime  @default(now()) @map("assigned_at") @db.Timestamptz(6)
  releasedAt      DateTime? @map("released_at") @db.Timestamptz(6)
  roleDescription String?   @map("role_description") @db.Text

  // Relations
  child      Child      @relation(fields: [childId], references: [id], onDelete: Cascade)
  specialist Specialist @relation(fields: [specialistId], references: [id], onDelete: Cascade)

  @@unique([childId, specialistId, specialization])
  @@map("children_specialists")
}

// ============================================================
// DIAGNOSTICS
// ============================================================

/// Диагностические сессии (M-CHAT, CAST, SCQ, Vineland-3 и т.д.)
model DiagnosticSession {
  id                  String    @id @default(uuid()) @db.Uuid
  childId             String    @map("child_id") @db.Uuid
  performedBy         String    @map("performed_by") @db.Uuid
  /// Код опросника: MCHAT_R_F, CAST, SCQ, VINELAND_3
  questionnaireCode   String    @map("questionnaire_code") @db.VarChar(100)
  startedAt           DateTime  @map("started_at") @db.Timestamptz(6)
  completedAt         DateTime? @map("completed_at") @db.Timestamptz(6)
  /// Статус: draft, in_progress, completed, cancelled
  status              String    @default("draft") @db.VarChar(20)
  scoreTotal          Decimal?  @map("score_total") @db.Decimal(10, 2)
  scoreRaw            Json?     @map("score_raw") @db.JsonB
  /// Уровень интерпретации: low_risk, moderate_risk, high_risk
  interpretationLevel String?   @map("interpretation_level") @db.VarChar(50)
  notes               String?   @db.Text

  // Relations
  child      Child                    @relation(fields: [childId], references: [id], onDelete: Cascade)
  specialist User                     @relation("PerformedBy", fields: [performedBy], references: [id], onDelete: Restrict)
  results    DiagnosticSessionResult?

  @@map("diagnostic_sessions")
}

/// Детальные результаты диагностики (ответы, подсчеты, флаги риска)
model DiagnosticSessionResult {
  sessionId String @id @map("session_id") @db.Uuid
  answers   Json   @db.JsonB
  scoring   Json?  @db.JsonB
  riskFlags Json?  @map("risk_flags") @db.JsonB

  // Relations
  session DiagnosticSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("diagnostic_session_results")
}

// ============================================================
// EXERCISES
// ============================================================

/// Библиотека упражнений
model Exercise {
  id              String   @id @default(uuid()) @db.Uuid
  title           String   @db.VarChar(255)
  slug            String   @unique @db.VarChar(255)
  description     String?  @db.Text
  category        String?  @db.VarChar(100)
  ageMin          Int?     @map("age_min")
  ageMax          Int?     @map("age_max")
  /// Сложность: beginner, intermediate, advanced
  difficulty      String?  @db.VarChar(20)
  durationMinutes Int?     @map("duration_minutes")
  materials       Json?    @db.JsonB
  instructions    Json?    @db.JsonB
  successCriteria Json?    @map("success_criteria") @db.JsonB
  mediaAssets     Json?    @map("media_assets") @db.JsonB
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  assignments    Assignment[]
  phaseExercises PhaseExercise[]
  goalExercises  GoalExercise[]

  @@map("exercise")
}

// ============================================================
// ROUTES (КОРРЕКЦИОННЫЕ МАРШРУТЫ)
// ============================================================

/// Коррекционный маршрут
model Route {
  id                 String    @id @default(uuid()) @db.Uuid
  childId            String    @map("child_id") @db.Uuid
  leadSpecialistId   String    @map("lead_specialist_id") @db.Uuid
  templateId         String?   @map("template_id") @db.Uuid
  activeVersionId    String?   @map("active_version_id") @db.Uuid
  baselineSnapshotId String?   @map("baseline_snapshot_id") @db.Uuid
  title              String    @db.VarChar(255)
  summary            String?   @db.Text
  /// Статус: draft, active, paused, completed, archived
  status             String    @default("draft") @db.VarChar(20)
  planHorizonWeeks   Int?      @map("plan_horizon_weeks")
  startDate          DateTime? @map("start_date") @db.Date
  endDate            DateTime? @map("end_date") @db.Date
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  child          Child        @relation(fields: [childId], references: [id], onDelete: Cascade)
  leadSpecialist Specialist   @relation("LeadSpecialist", fields: [leadSpecialistId], references: [id], onDelete: Restrict)
  goals          RouteGoal[]
  phases         RoutePhase[]
  assignments    Assignment[]

  // TODO: Partial unique constraint требует PostgreSQL 15+ и Prisma 5.10+
  // @@unique([childId], map: "uniq_active_route_per_child", where: { status: "active" })
  @@map("route")
}

/// Цели маршрута
model RouteGoal {
  id                String   @id @default(uuid()) @db.Uuid
  routeId           String   @map("route_id") @db.Uuid
  phaseId           String?  @map("phase_id") @db.Uuid
  category          String   @db.VarChar(100)
  /// Тип цели: skill, behaviour, academic, other
  goalType          String   @map("goal_type") @db.VarChar(50)
  description       String   @db.VarChar(512)
  targetMetric      String   @map("target_metric") @db.VarChar(128)
  measurementUnit   String   @map("measurement_unit") @db.VarChar(50)
  baselineValue     String?  @map("baseline_value") @db.VarChar(64)
  targetValue       String?  @map("target_value") @db.VarChar(64)
  reviewPeriodWeeks Int      @map("review_period_weeks")
  /// Приоритет: high, medium, low
  priority          String   @db.VarChar(20)
  status            String   @db.VarChar(50)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  route         Route          @relation(fields: [routeId], references: [id], onDelete: Cascade)
  phase         RoutePhase?    @relation(fields: [phaseId], references: [id], onDelete: SetNull)
  goalExercises GoalExercise[]

  @@map("route_goals")
}

/// Фазы маршрута
model RoutePhase {
  id                      String    @id @default(uuid()) @db.Uuid
  routeId                 String    @map("route_id") @db.Uuid
  responsibleSpecialistId String    @map("responsible_specialist_id") @db.Uuid
  name                    String    @db.VarChar(64)
  description             String    @db.VarChar(512)
  orderIndex              Int       @map("order_index")
  parallelGroup           Int?      @map("parallel_group")
  /// Статус: planned, active, on_hold, completed
  status                  String    @default("planned") @db.VarChar(20)
  startDate               DateTime? @map("start_date") @db.Date
  endDate                 DateTime? @map("end_date") @db.Date
  durationWeeks           Int       @map("duration_weeks")
  expectedOutcomes        String    @map("expected_outcomes") @db.VarChar(1024)
  notes                   String?   @db.VarChar(512)
  createdAt               DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  route          Route           @relation(fields: [routeId], references: [id], onDelete: Cascade)
  goals          RouteGoal[]
  phaseExercises PhaseExercise[]
  assignments    Assignment[]

  @@unique([routeId, orderIndex])
  @@map("route_phases")
}

/// Связь фаза - упражнение (M:N)
model PhaseExercise {
  id               String  @id @default(uuid()) @db.Uuid
  phaseId          String  @map("phase_id") @db.Uuid
  exerciseId       String  @map("exercise_id") @db.Uuid
  orderIndex       Int     @map("order_index")
  frequencyPerWeek Int     @map("frequency_per_week")
  durationMinutes  Int     @map("duration_minutes")
  notes            String? @db.Text
  isMandatory      Boolean @default(false) @map("is_mandatory")

  // Relations
  phase    RoutePhase @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  exercise Exercise   @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@unique([phaseId, orderIndex])
  @@map("phase_exercises")
}

/// Связь цель - упражнение (M:N)
model GoalExercise {
  id                String  @id @default(uuid()) @db.Uuid
  goalId            String  @map("goal_id") @db.Uuid
  exerciseId        String  @map("exercise_id") @db.Uuid
  /// Уровень вклада: primary, supporting
  contributionLevel String  @map("contribution_level") @db.VarChar(50)
  notes             String? @db.Text

  // Relations
  goal     RouteGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)
  exercise Exercise  @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@map("goal_exercises")
}

// ============================================================
// ASSIGNMENTS (НАЗНАЧЕНИЯ)
// ============================================================

/// Назначения упражнений детям
model Assignment {
  id                      String   @id @default(uuid()) @db.Uuid
  childId                 String   @map("child_id") @db.Uuid
  exerciseId              String   @map("exercise_id") @db.Uuid
  assignedById            String   @map("assigned_by_id") @db.Uuid
  specialistId            String   @map("specialist_id") @db.Uuid
  routeId                 String   @map("route_id") @db.Uuid
  phaseId                 String   @map("phase_id") @db.Uuid
  targetGoalId            String?  @map("target_goal_id") @db.Uuid
  assignedAt              DateTime @default(now()) @map("assigned_at") @db.Timestamptz(6)
  plannedStartDate        DateTime @map("planned_start_date") @db.Date
  dueDate                 DateTime @map("due_date") @db.Date
  /// Статус: assigned, in_progress, completed, overdue, cancelled
  status                  String   @default("assigned") @db.VarChar(20)
  /// Канал выполнения: in_person, home, telepractice
  deliveryChannel         String   @map("delivery_channel") @db.VarChar(50)
  notes                   String?  @db.Text
  frequencyPerWeek        Int      @map("frequency_per_week")
  expectedDurationMinutes Int      @map("expected_duration_minutes")
  reminderPolicy          Json?    @map("reminder_policy") @db.JsonB

  // Relations
  child      Child      @relation(fields: [childId], references: [id], onDelete: Cascade)
  exercise   Exercise   @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  assignedBy User       @relation("AssignedBy", fields: [assignedById], references: [id], onDelete: Restrict)
  specialist Specialist @relation("SpecialistAssignments", fields: [specialistId], references: [userId], onDelete: Restrict)
  route      Route      @relation(fields: [routeId], references: [id], onDelete: Cascade)
  phase      RoutePhase @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  reports    Report[]

  @@map("assignments")
}

// ============================================================
// REPORTS (ОТЧЕТЫ)
// ============================================================

/// Отчеты о выполнении назначений от родителей
model Report {
  id              String    @id @default(uuid()) @db.Uuid
  assignmentId    String    @map("assignment_id") @db.Uuid
  parentId        String    @map("parent_id") @db.Uuid
  reviewedBy      String?   @map("reviewed_by") @db.Uuid
  submittedAt     DateTime  @default(now()) @map("submitted_at") @db.Timestamptz(6)
  /// Статус выполнения: completed, partial, failed
  status          String    @db.VarChar(20)
  durationMinutes Int       @map("duration_minutes")
  /// Настроение ребенка: good, neutral, difficult
  childMood       String    @map("child_mood") @db.VarChar(20)
  feedbackText    String    @map("feedback_text") @db.Text
  media           Json?     @db.JsonB
  autoScore       Decimal?  @map("auto_score") @db.Decimal(5, 2)
  reviewedAt      DateTime? @map("reviewed_at") @db.Timestamptz(6)
  /// Статус проверки: not_reviewed, approved, needs_attention, rejected
  reviewStatus    String    @default("not_reviewed") @map("review_status") @db.VarChar(50)

  // Relations
  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  parent     User       @relation("ParentReports", fields: [parentId], references: [id], onDelete: Restrict)

  @@map("reports")
}

// ============================================================
// СОБЫТИЯ (EVENT OUTBOX)
// ============================================================

/// Outbox для доменных событий
model EventOutbox {
  id            String    @id @default(uuid()) @db.Uuid
  eventName     String    @map("event_name") @db.VarChar(255)
  aggregateType String    @map("aggregate_type") @db.VarChar(100)
  aggregateId   String    @map("aggregate_id") @db.Uuid
  payload       Json      @db.JsonB
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  publishedAt   DateTime? @map("published_at") @db.Timestamptz(6)
  /// Статус: pending, published, failed
  status        String    @default("pending") @db.VarChar(20)

  @@index([status, createdAt])
  @@map("event_outbox")
}

/// DLQ для неуспешных публикаций событий
model EventOutboxFailure {
  id               String    @id @default(uuid()) @db.Uuid
  originalOutboxId String    @map("original_outbox_id") @db.Uuid
  payload          Json      @db.JsonB
  errorSummary     String    @map("error_summary") @db.Text
  retryCount       Int       @default(0) @map("retry_count")
  failedAt         DateTime  @default(now()) @map("failed_at") @db.Timestamptz(6)
  reprocessedAt    DateTime? @map("reprocessed_at") @db.Timestamptz(6)

  @@map("event_outbox_failures")
}
