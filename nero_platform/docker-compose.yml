version: '3.8'

services:
  # PostgreSQL Database - порт 5437 (не стандартный 5432)
  postgres:
    image: postgres:15-alpine
    container_name: neiro_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: neiro_platform
      POSTGRES_USER: neiro_user
      POSTGRES_PASSWORD: neiro_password_dev
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5437:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U neiro_user -d neiro_platform"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: neiro_redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO S3-compatible storage
  minio:
    image: minio/minio:latest
    container_name: neiro_minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # Adminer - Database Management UI
  adminer:
    image: adminer:latest
    container_name: neiro_adminer
    restart: unless-stopped
    ports:
      - "8082:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres
    depends_on:
      - postgres

  # Node.js Application Container
  # КРИТИЧНО: Весь код исполняется здесь, не на хосте!
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: neiro_app
    restart: unless-stopped
    working_dir: /app
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://neiro_user:neiro_password_dev@postgres:5432/neiro_platform
      REDIS_URL: redis://redis:6379
      MINIO_ENDPOINT: minio
      MINIO_PORT: 9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin123
      MINIO_USE_SSL: false
      # JWT Secrets для Auth Service
      JWT_ACCESS_SECRET: dev_access_secret_change_in_production_2024
      JWT_REFRESH_SECRET: dev_refresh_secret_change_in_production_2024
      JWT_ACCESS_EXPIRES_IN: 15m
      JWT_REFRESH_EXPIRES_IN: 7d
    ports:
      - "3001:3001"  # Next.js frontend (порт 3001 внутри контейнера для соответствия CORS)
      - "4001:4000"  # API Gateway (Auth Service)
      - "4002:4002"  # Users Service
      - "4003:4003"  # Children Service
      - "4004:4004"  # Profiles Service
      - "4005:4005"  # Route Orchestrator Service
      - "4006:4006"  # Assignments Service
      - "4007:4007"  # Exercises Service
      - "4008:4008"  # Templates Service
    volumes:
      # Mount source code for hot reload (редактируем на хосте, исполняем в контейнере)
      - ./package.json:/app/package.json:ro
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml:ro
      - ./turbo.json:/app/turbo.json:ro
      - ./apps:/app/apps
      - ./services:/app/services
      - ./packages:/app/packages
      - ./infrastructure:/app/infrastructure
      # Persist node_modules in volume (не на хосте!)
      - node_modules:/app/node_modules
      - app_node_modules:/app/apps/web/node_modules
      # Отдельные volumes для node_modules каждого пакета
      - packages_database_nm:/app/packages/database/node_modules
      - packages_types_nm:/app/packages/types/node_modules
      - packages_utils_nm:/app/packages/utils/node_modules
      # Volumes для node_modules новых сервисов (Месяц 2)
      - services_routes_nm:/app/services/routes/node_modules
      - services_assignments_nm:/app/services/assignments/node_modules
      - services_exercises_nm:/app/services/exercises/node_modules
      - services_templates_nm:/app/services/templates/node_modules
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    # Команда по умолчанию - просто держать контейнер запущенным
    # Разработчики запускают команды вручную через: docker-compose exec app <command>
    command: tail -f /dev/null

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local
  node_modules:
    driver: local
  app_node_modules:
    driver: local
  # Отдельные volumes для node_modules пакетов
  packages_database_nm:
    driver: local
  packages_types_nm:
    driver: local
  packages_utils_nm:
    driver: local
  # Volumes для новых сервисов (Месяц 2)
  services_routes_nm:
    driver: local
  services_assignments_nm:
    driver: local
  services_exercises_nm:
    driver: local
  services_templates_nm:
    driver: local

networks:
  default:
    name: neiro_network

