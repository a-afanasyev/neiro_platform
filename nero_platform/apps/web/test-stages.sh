#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ E2E —Ç–µ—Å—Ç–æ–≤ –ø–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º —ç—Ç–∞–ø–∞–º
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./test-stages.sh [stage_number]
# –ë–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞
print_header() {
    echo ""
    echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
run_tests() {
    local stage_name="$1"
    local test_file="$2"

    print_header "$stage_name"

    if pnpm exec playwright test "$test_file" --reporter=list; then
        echo -e "${GREEN}‚úÖ $stage_name - –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´${NC}"
        return 0
    else
        echo -e "${RED}‚ùå $stage_name - –ï–°–¢–¨ –ü–†–û–í–ê–õ–ï–ù–ù–´–ï –¢–ï–°–¢–´${NC}"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω—é
show_menu() {
    print_header "E2E –¢–ï–°–¢–´ - –í–´–ë–û–† –≠–¢–ê–ü–ê"

    echo -e "${GREEN}‚úÖ –≠—Ç–∞–ø—ã —Å –ø–æ–ª–Ω—ã–º –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ–º:${NC}"
    echo "  1) –≠—Ç–∞–ø 1: –ë–∞–∑–æ–≤–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (12/12)"
    echo "  2) –≠—Ç–∞–ø 2: CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç—å–º–∏ (7/7)"
    echo ""

    echo -e "${YELLOW}‚ö†Ô∏è  –≠—Ç–∞–ø—ã —Å —á–∞—Å—Ç–∏—á–Ω—ã–º –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ–º:${NC}"
    echo "  3) –≠—Ç–∞–ø 3: CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏"
    echo "  4) –≠—Ç–∞–ø 4: Dashboard –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è"
    echo "  5) –≠—Ç–∞–ø 5: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏"
    echo "  6) –≠—Ç–∞–ø 6: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
    echo "  7) –≠—Ç–∞–ø 7: –ü—Ä–æ–≥—Ä–µ—Å—Å –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞"
    echo "  8) –≠—Ç–∞–ø 8: –û—Ç—á–µ—Ç—ã"
    echo "  9) –≠—Ç–∞–ø 9: CJM –±–∞–∑–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏"
    echo ""

    echo -e "${RED}‚ùå –≠—Ç–∞–ø—ã —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø—Ä–æ–±–ª–µ–º–∞–º–∏:${NC}"
    echo " 10) –≠—Ç–∞–ø 10: CJM —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–º–Ω–æ–≥–æ —Ç–∞–π–º–∞—É—Ç–æ–≤)"
    echo ""

    echo -e "${BLUE}üìã –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏:${NC}"
    echo " 11) –ó–∞–ø—É—Å—Ç–∏—Ç—å –í–°–ï —Ç–µ—Å—Ç—ã"
    echo " 12) –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã–µ —Ç–µ—Å—Ç—ã (—ç—Ç–∞–ø 1-2)"
    echo " 13) –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å –æ—Ç–ª–∞–¥–∫–æ–π (headed mode)"
    echo " 14) –û—Ç–∫—Ä—ã—Ç—å Playwright UI"
    echo ""
    echo "  0) –í—ã—Ö–æ–¥"
    echo ""
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
main() {
    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    if [ ! -f "playwright.config.ts" ]; then
        echo -e "${RED}–û—à–∏–±–∫–∞: playwright.config.ts –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
        echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ nero_platform/apps/web"
        exit 1
    fi

    # –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –∞—Ä–≥—É–º–µ–Ω—Ç, –∑–∞–ø—É—Å–∫–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —ç—Ç–∞–ø
    if [ $# -eq 1 ]; then
        STAGE=$1
    else
        # –ò–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
        show_menu
        read -p "–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø (0-14): " STAGE
    fi

    case $STAGE in
        1)
            run_tests "–≠—Ç–∞–ø 1: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è" "auth.spec.ts"
            ;;
        2)
            run_tests "–≠—Ç–∞–ø 2: CRUD –¥–µ—Ç–µ–π" "children-crud.spec.ts"
            ;;
        3)
            run_tests "–≠—Ç–∞–ø 3: CRUD –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" "users-crud.spec.ts"
            ;;
        4)
            run_tests "–≠—Ç–∞–ø 4: Dashboard" "dashboard.spec.ts"
            ;;
        5)
            run_tests "–≠—Ç–∞–ø 5: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏" "parent-management.spec.ts"
            ;;
        6)
            run_tests "–≠—Ç–∞–ø 6: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" "notifications.spec.ts"
            ;;
        7)
            run_tests "–≠—Ç–∞–ø 7: –ü—Ä–æ–≥—Ä–µ—Å—Å" "progress.spec.ts"
            ;;
        8)
            run_tests "–≠—Ç–∞–ø 8: –û—Ç—á–µ—Ç—ã" "reports.spec.ts"
            ;;
        9)
            run_tests "–≠—Ç–∞–ø 9: CJM –±–∞–∑–æ–≤—ã–µ" "cjm.spec.ts"
            ;;
        10)
            run_tests "–≠—Ç–∞–ø 10: CJM —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ" "cjm-extended.spec.ts"
            ;;
        11)
            print_header "–ó–ê–ü–£–°–ö –í–°–ï–• –¢–ï–°–¢–û–í"
            pnpm test:e2e
            ;;
        12)
            print_header "–ó–ê–ü–£–°–ö –£–°–ü–ï–®–ù–´–• –¢–ï–°–¢–û–í (–≠—Ç–∞–ø 1-2)"
            pnpm exec playwright test auth.spec.ts children-crud.spec.ts --reporter=list
            ;;
        13)
            print_header "–û–¢–õ–ê–î–ö–ê –ü–†–û–ë–õ–ï–ú–ù–´–• –¢–ï–°–¢–û–í (Headed Mode)"
            echo "–ó–∞–ø—É—Å–∫ cjm-extended.spec.ts –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏..."
            pnpm exec playwright test cjm-extended.spec.ts --headed --max-failures=1
            ;;
        14)
            print_header "PLAYWRIGHT UI"
            pnpm test:e2e:ui
            ;;
        0)
            echo "–í—ã—Ö–æ–¥..."
            exit 0
            ;;
        *)
            echo -e "${RED}–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.${NC}"
            exit 1
            ;;
    esac
}

# –ó–∞–ø—É—Å–∫
main "$@"
