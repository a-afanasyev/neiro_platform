# Конфигурация API Gateway для Neiro Platform
# Маршрутизация запросов на микросервисы

worker_processes 1;

events {
    worker_connections 1024;
}

http {
    # Определение upstream серверов для каждого микросервиса
    # Используем внутренние порты контейнеров
    upstream auth_service {
        server auth:4000;
    }

    upstream users_service {
        server users:4002;
    }

    upstream children_service {
        server children:4003;
    }

    upstream diagnostics_service {
        server diagnostics:4004;
    }

    upstream routes_service {
        server routes:4005;
    }

    upstream assignments_service {
        server assignments:4006;
    }

    upstream exercises_service {
        server exercises:4007;
    }

    upstream templates_service {
        server templates:4008;
    }

    upstream reports_service {
        server reports:4009;
    }

    server {
        listen 8080;
        server_name localhost;

        # Логирование
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        # CORS обрабатывается на уровне backend сервисов
        # Общие настройки для всех proxy
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Таймауты
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Маршрутизация на Auth Service (порт 4000)
        location /auth/ {
            proxy_pass http://auth_service/auth/;
        }

        # Маршрутизация на Users Service (порт 4002)
        location /users/ {
            proxy_pass http://users_service/users/;
        }

        # Маршрутизация на Children Service (порт 4003)
        location /children/ {
            proxy_pass http://children_service/children/;
        }

        # Маршрутизация на Diagnostics Service (порт 4004)
        location /diagnostics/ {
            proxy_pass http://diagnostics_service/diagnostics/;
        }

        # Маршрутизация на Routes Service (порт 4005)
        location /routes/ {
            proxy_pass http://routes_service/routes/;
        }

        # Маршрутизация на Assignments Service (порт 4006)
        location /assignments/ {
            proxy_pass http://assignments_service/assignments/;
        }

        # Маршрутизация на Exercises Service (порт 4007)
        location /exercises/ {
            proxy_pass http://exercises_service/exercises/;
        }

        # Маршрутизация на Templates Service (порт 4008)
        location /templates/ {
            proxy_pass http://templates_service/templates/;
        }

        # Маршрутизация на Reports Service (порт 4009) - Month 3
        location /reports/ {
            proxy_pass http://reports_service/reports/;
        }

        # Маршрутизация на Media Service (Reports Service, порт 4009) - Month 3
        location /media/ {
            proxy_pass http://reports_service/media/;
        }

        # Health check endpoint для самого Gateway
        location /health {
            access_log off;
            return 200 "Gateway is healthy\n";
            add_header Content-Type text/plain;
        }

        # Обработка ошибок
        # Используем internal redirect для обработки ошибок 502, 503, 504
        error_page 502 503 504 /50x.html;
        location = /50x.html {
            internal;
            default_type text/plain;
            return 502 "Service temporarily unavailable\n";
        }
    }
}

