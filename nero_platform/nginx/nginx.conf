events {
    worker_connections 1024;
}

http {
    # Upstream definitions using Docker service names (DNS resolution)
    upstream auth_service {
        server auth:4000;
    }

    upstream users_service {
        server users:4002;
    }

    upstream children_service {
        server children:4003;
    }

    upstream diagnostics_service {
        server diagnostics:4004;
    }

    upstream routes_service {
        server routes:4005;
    }

    upstream assignments_service {
        server assignments:4006;
    }

    upstream exercises_service {
        server exercises:4007;
    }

    upstream templates_service {
        server templates:4008;
    }

    upstream reports_service {
        server reports:4009;
    }

    upstream analytics_service {
        server analytics:4010;
    }

    upstream notifications_service {
        server notifications:4011;
    }

    upstream media_service {
        server reports:4009;
    }

    server {
        listen 8080;
        server_name localhost;

        # Logging
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        # Common proxy settings
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Auth Service routes
        location /auth/ {
            proxy_pass http://auth_service;
        }

        # Users Service routes
        location /users/ {
            proxy_pass http://users_service;
        }

        # Children Service routes
        location /children/ {
            proxy_pass http://children_service;
        }

        # Diagnostics Service routes
        location /diagnostics/ {
            proxy_pass http://diagnostics_service;
        }

        # Routes Service routes
        location /routes/ {
            proxy_pass http://routes_service;
        }

        # Assignments Service routes
        location /assignments/ {
            proxy_pass http://assignments_service;
        }

        # Exercises Service routes
        location /exercises/ {
            proxy_pass http://exercises_service;
        }

        # Templates Service routes
        location /templates/ {
            proxy_pass http://templates_service;
        }

        # Reports Service routes
        location /reports/ {
            proxy_pass http://reports_service;
        }

        # Analytics Service routes
        location /analytics/ {
            proxy_pass http://analytics_service;
        }

        # Notifications Service routes
        location /notifications/ {
            proxy_pass http://notifications_service;
        }

        # Media Service routes (handled by reports service)
        location /media/ {
            proxy_pass http://media_service;
        }

        # Root path routes to web application
        location / {
            proxy_pass http://web:3001/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Gateway health check endpoint
        location /health {
            access_log off;
            return 200 "Gateway is healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
