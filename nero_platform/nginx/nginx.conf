events {
    worker_connections 1024;
}

http {
    # Определение upstream серверов для каждого микросервиса
    # Используем внутренние порты контейнеров
    upstream auth_service {
        server 172.28.0.14:4000;
    }

    upstream users_service {
        server 172.28.0.6:4002;
    }

    upstream children_service {
        server 172.28.0.13:4003;
    }

    upstream diagnostics_service {
        server 172.28.0.8:4004;
    }

    upstream routes_service {
        server 172.28.0.3:4005;
    }

    upstream assignments_service {
        server 172.28.0.7:4006;
    }

    upstream exercises_service {
        server 172.28.0.5:4007;
    }

    upstream templates_service {
        server 172.28.0.9:4008;
    }

    upstream reports_service {
        server 172.28.0.4:4009;
    }

    upstream analytics_service {
        server 172.28.0.15:4010;
    }

    upstream notifications_service {
        server 172.28.0.16:4011;
    }

    server {
        listen 8080;
        server_name localhost;

        # Логирование
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        # CORS обрабатывается на уровне backend сервисов
        # Общие настройки для всех proxy
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Маршрутизация на Auth Service (порт 4000)
        location /auth/ {
            proxy_pass http://auth_service/auth/;
        }

        # Маршрутизация на Users Service (порт 4002)
        location /users/ {
            proxy_pass http://users_service/users/;
        }

        # Маршрутизация на Children Service (порт 4003)
        location /children/ {
            proxy_pass http://children_service/children/;
        }

        # Маршрутизация на Diagnostics Service (порт 4004)
        location /diagnostics/ {
            proxy_pass http://diagnostics_service/diagnostics/;
        }

        # Маршрутизация на Routes Service (порт 4005)
        location /routes/ {
            proxy_pass http://routes_service/routes/;
        }

        # Маршрутизация на Assignments Service (порт 4006)
        location /assignments/ {
            proxy_pass http://assignments_service/assignments/;
        }

        # Маршрутизация на Exercises Service (порт 4007)
        location /exercises/ {
            proxy_pass http://exercises_service/exercises/;
        }

        # Маршрутизация на Templates Service (порт 4008)
        location /templates/ {
            proxy_pass http://templates_service/templates/;
        }

        # Маршрутизация на Reports Service (порт 4009)
        location /reports/ {
            proxy_pass http://reports_service/reports/;
        }

        # Маршрутизация на Analytics Service (порт 4010)
        location /analytics/ {
            proxy_pass http://analytics_service/analytics/;
        }

        # Маршрутизация на Notifications Service (порт 4011)
        location /notifications/ {
            proxy_pass http://notifications_service/notifications/;
        }

        # Маршрутизация корневого пути на веб-приложение
        location / {
            proxy_pass http://172.28.0.11:3001/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Health check endpoint для самого Gateway
        location /health {
            access_log off;
            return 200 "Gateway is healthy\n";
            add_header Content-Type text/plain;
        }
    }
}

