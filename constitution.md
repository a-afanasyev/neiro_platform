# Конституция проекта Neiro

Документ задаёт неизменяемые принципы, технологические ограничения и quality gates для всех работ в репозитории. Любая новая фича/сервис/интеграция должна соответствовать этим правилам и проходить проверки «Constitution Check» в планах.

## 1. Обзор платформы

Neiro — современная цифровая платформа на базе Next.js, PostgreSQL и MinIO, построенная по сервисной архитектуре с открытыми API. Она объединяет диагностику, коррекционные маршруты, терапию, коммуникации и аналитику в едином пространстве для нейропсихологов, родителей и организаций.

- **BFF/Frontend**: Next.js (TypeScript)
- **База данных**: PostgreSQL (основное хранилище)
- **Файлы/мультимедиа**: MinIO (S3-совместимое хранилище)
- **Кэш/очереди**: Redis
- **Коммуникации между модулями**: REST/tRPC + событийные очереди
- **Модули**: `auth`, `diagnostics`, `route-orchestrator`, `exercises`, `comms`, `reports`, `analytics`, `rtc-media`
- **Интеграции**: Telegram, календари, внешние медицинские/образовательные платформы

## 2. Архитектурные принципы

- **Модульность и границы**: каждый сервис владеет своей моделью данных и публичным контрактом; доступ к данным — только через API сервиса-владельца.
- **Открытые контракты**: REST (OpenAPI 3.1) или tRPC (строго типизированные роутеры); изменения — через версионирование.
- **Событийность**: важные доменные события публикуются в очередь; подписчики обрабатывают их асинхронно.
- **Надёжность и масштабируемость**: горизонтальное масштабирование, идемпотентные обработчики.
- **Безопасность по умолчанию**: минимальные привилегии, шифрование на транзите, аудит действий.
- **Простота реализации**: избегаем сложных техник (наследование, рефлексия, динамические трюки). Код должен быть понятен джуну.
- **Обратная совместимость**: не ломать клиентов; деprecation-периоды с предупреждениями.
- **DRY (Don't Repeat Yourself)**: общий функционал (export, visualization, storage, auth, logging) реализуется один раз в shared libraries и переиспользуется всеми модулями через чёткие API.

## 3. Технологический стек (строго)

- **Frontend/BFF**: Next.js 14+ (TypeScript), React Server Components там, где оправдано.
- **Backend-сервисы**: TypeScript/Node.js (предпочтительно) или совместимые технологии по согласованию.
- **БД**: PostgreSQL (миграции через выбранный инструмент, единые практики версионирования схем).
- **Объекты**: MinIO (S3 API), приватные бакеты, presigned URL для загрузок/скачиваний.
- **Кэш/Очереди**: Redis (ключи с неймспейсами, TTL где необходимо; очереди/стримы для событий).
- **API**: REST с OpenAPI 3.1 ИЛИ tRPC; одно из двух должно быть задокументировано и проверяемо.

## 4. Сервисы и их границы ответственности

- **auth**: аутентификация (JWT/refresh), авторизация (RBAC), управление сессиями.
- **diagnostics**: сбор и хранение диагностических данных, тестовые протоколы.
- **route-orchestrator**: формирование и управление коррекционными маршрутами.
- **exercises**: упражнения/контент, трекинг выполнения, хранение артефактов в S3.
- **comms**: сообщения, уведомления, интеграции с мессенджерами/календарями.
- **reports**: отчёты, экспорт, шаблоны.
- **analytics**: агрегаты, метрики, витрины.
- **rtc-media**: медиа-сессии в реальном времени, сигнальный слой.

Любое пересечение границ требует явного API-контракта. Прямое чтение чужих таблиц запрещено.

## 5. Данные и соответствие требованиям

- **Владение данными**: таблицами владеет один сервис; доступ — через его API.
- **PII/чувствительные данные**: минимизация, маскирование в логах, аудит доступа.
- **Retention (общая политика для всех фич)**:
  - Медицинские данные (assessments, diagnoses, routes, medical reports, exercise assignments) — **7 лет**
  - Видео/медиа сессий (video recordings, session recordings) — **3 года** (с согласия участников)
  - Audit logs и immutable history (RouteHistory, DSAR logs) — **бессрочно** или минимум **1 год** для operational audit
  - Aggregated metrics, analytics data — **3 года**
  - Chat messages, notifications history — **3 года**
  - Raw event data для агрегации — **1 год**
  - Temporary/cache data — **30 дней**
  - Template versions (assessment/exercise templates) — **бессрочно** (audit trail)
  - Автоматическая очистка по истечении срока обязательна
- **Миграции**: версия схемы инкрементальная; миграции атомарные и обратимые; тестирование на стейдже обязательно.

## 6. Контракты API и совместимость

- **REST**: спецификации OpenAPI 3.1 публикуются рядом с сервисом; проверки линтерами обязательны.
- **tRPC**: типобезопасные роутеры; договорённости о versioning (например, неймспейсы `v1`).
- **Версионирование**: мажорные изменения — только через новую версию API; старые версии поддерживаются ограниченное время с Deprecation-уведомлениями.

## 7. События и очереди

- **Шина событий**: Redis Streams/Lists; имена — `domain.eventName.v1`.
- **Идемпотентность**: обработчики обязаны уметь повторно обрабатывать сообщение.
- **Dead-letter**: обязательные DLQ и алерты при превышении порогов ошибок.

## 8. Безопасность

- **Аутентификация**: JWT с короткоживущими access-токенами и refresh-механизмом; HttpOnly cookies или заголовки.
- **Авторизация**: RBAC; проверка ролей на границе BFF/сервиса.
- **Транспорт**: TLS обязателен вне локальной разработки.
- **Секреты**: только через переменные окружения/секрет-хранилища; запрет коммитить секреты.
- **Rate limiting**: на внешних границах и чувствительных эндпойнтах.
- **Аудит**: логирование ключевых действий пользователя и админа.

## 9. Наблюдаемость и качество

- **Логи**: структурированные, без PII; корреляция по trace/request id.
- **Метрики**: базовые (RPS, p95/p99 latency, ошибки), бизнес-метрики per сервис.
- **Трейсинг**: распределённые трассы для межсервисных вызовов (если применимо).
- **Тесты**: минимум unit + интеграционные для контрактов; для критичных потоков — e2e.

## 10. Производительность и SLO

- **Цели по задержкам**: p95 < 200ms для публичных API BFF; внутренние — < 100ms, если не оговорено иначе.
- **Надёжность**: целевой аптайм сервиса 99.9% (если не указано иначе).
- **Бюджеты**: размер ответов, время генерации отчётов, лимиты очередей — должны быть зафиксированы в планах.

## 11. Интеграции с внешними системами

- **Шлюз интеграций**: все внешние подключения идут через слой интеграций сервиса `comms` или специализированные адаптеры.
- **Протоколы**: вебхуки, OAuth2/OIDC, подписки/пулы — с ретраями и idempotency-keys.
- **Изоляция**: деградация внешнего провайдера не должна ломать ядро; таймауты/фолбэки обязательны.

## 12. Контейнеры и окружения

- **Локальная разработка**: выполняется исключительно внутри Docker/Compose-контейнеров; bare-metal запуск допускается только по согласованному исключению.
- **Тестирование**: unit, integration и e2e-прогоны локально и в CI выполняются в контейнерах с теми же базовыми образами, что и прод.
- **База данных**: если есть контейнер БД с рабочими данными, его **нельзя удалять**.
- **Обновления**: перед деплоем/миграциями — прогон на стейдж-окружении с теми же версиями образов.

## 13. Процесс разработки

- **Ветвление**: фичи создаются через `.specify/scripts/bash/create-new-feature.sh` (ветка `NNN-short-name`).
- **Спеки/планы**: для каждой фичи — `specs/NNN-*/spec.md`, затем `plan.md`, `contracts/`, `tasks.md`.
- **Definition of Done**: пройдены все gates, тесты зелёные, документация обновлена.

## 14. Конституционные GATES (обязательные проверки)

Каждый план должен явно отметить прохождение пунктов ниже:

- [ ] **Stack Compliance**: используются разрешённые технологии (Next.js/TS, PostgreSQL, MinIO, Redis, REST/tRPC).
- [ ] **Service Boundaries**: определены владелец данных и границы; нет прямого доступа к чужим таблицам.
- [ ] **API Contract**: есть OpenAPI 3.1 или tRPC-роутер; указано версионирование и совместимость.
- [ ] **Events**: задокументированы публикуемые/подписываемые события, названы по конвенции, продуман DLQ.
- [ ] **Security Baseline**: аутентификация/авторизация, секреты, TLS, rate limiting — описаны и реализуемы.
- [ ] **Data Policy**: PII-правила, ретеншн, миграции и обратимость — зафиксированы.
- [ ] **Observability**: логи, метрики, трассировка (если нужно) — описаны.
- [ ] **Performance/SLO**: цели по p95/ошибкам/бюджетам определены и достижимы.
- [ ] **Integration Isolation**: внешние зависимости оформлены через адаптеры с таймаутами/ретраями.
- [ ] **Containers Policy**: план обновлений учитывает наличие тестовых контейнеров; БД-контейнер не удаляется.

## 15. Исключения из правил

Допускаются только при явном обосновании в разделе "Complexity Tracking" плана:

- описание нарушения; зачем нужно; какие более простые альтернативы были отвергнуты.
- срок и план возврата к стандарту.

---

Последнее обновление: [заполнить при изменении]

