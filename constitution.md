# Конституция проекта Neiro

**Версия:** 1.1  
**Дата ратификации:** 2024-12-21  
**Последнее обновление:** 2025-10-31

Документ задаёт неизменяемые принципы, технологические ограничения и quality gates для всех работ в репозитории. Любая новая фича/сервис/интеграция должна соответствовать этим правилам и проходить проверки «Constitution Check» в планах.

## 1. Обзор платформы

Neiro — современная цифровая платформа на базе Next.js, PostgreSQL и MinIO, построенная по сервисной архитектуре с открытыми API. Она объединяет диагностику, коррекционные маршруты, терапию, коммуникации и аналитику в едином пространстве для нейропсихологов, родителей и организаций.

- **BFF/Frontend**: Next.js (TypeScript)
- **База данных**: PostgreSQL (основное хранилище)
- **Файлы/мультимедиа**: MinIO (S3-совместимое хранилище)
- **Кэш/очереди**: Redis
- **Коммуникации между модулями**: REST/tRPC + доменные события
- **Модули**:
  - `auth`: создание/обновление учётных записей, JWT/refresh, RBAC
  - `diagnostics`: диагностики, тестовые протоколы, результаты
  - `route-orchestrator`: построение маршрутов, жизненный цикл фаз/целей
  - `exercises`: библиотека упражнений, контент, хранение артефактов
  - `assignments`: назначения упражнений, статус выполнения, напоминания
  - `templates`: шаблоны маршрутов/оценок, версионирование, публикация
  - `comms`: чат, уведомления, календарные интеграции, Telegram/WebApp
  - `reports`: построение отчётов, экспорт, шаблоны документов
  - `analytics`: агрегаты, метрики, витрины для специалистов и руководителей
  - `specialists`: профили специалистов, лицензии, управление доступами
  - `media`: загрузка/проигрывание медиа, WebRTC сессии, сигнальный слой
  - `webhooks`: исходящие/входящие вебхуки, адаптеры внешних систем
  - `security-compliance`: журналы аудита, DSAR, ретеншн, инциденты
  - `rtc-media`: real-time медиа-сессии (если отделены от `media`)
- **Интеграции**: Telegram, календари, внешние медицинские/образовательные платформы

## 2. Архитектурные принципы

- **Модульность и границы**: каждый сервис владеет своей моделью данных и публичным контрактом; доступ к данным — только через API сервиса-владельца.
- **Открытые контракты**: REST (OpenAPI 3.1) или tRPC (строго типизированные роутеры); изменения — через версионирование.
- **Событийность**: важные доменные события публикуются в очередь; подписчики обрабатывают их асинхронно.
- **Надёжность и масштабируемость**: горизонтальное масштабирование, идемпотентные обработчики.
- **Безопасность по умолчанию**: минимальные привилегии, шифрование на транзите, аудит действий.
- **Простота реализации**: избегаем сложных техник (наследование, рефлексия, динамические трюки). Код должен быть понятен джуну.
- **Обратная совместимость**: не ломать клиентов; деprecation-периоды с предупреждениями.
- **DRY (Don't Repeat Yourself)**: общий функционал (export, visualization, storage, auth, logging) реализуется один раз в shared libraries и переиспользуется всеми модулями через чёткие API.

## 3. Технологический стек (строго)

- **Frontend/BFF**: Next.js 14+ (TypeScript), React Server Components там, где оправдано.
- **Backend-сервисы**: TypeScript/Node.js (предпочтительно) или совместимые технологии по согласованию.
- **БД**: PostgreSQL (миграции через выбранный инструмент, единые практики версионирования схем).
- **Объекты**: MinIO (S3 API), приватные бакеты, presigned URL для загрузок/скачиваний.
- **Кэш/Очереди**: Redis (ключи с неймспейсами, TTL где необходимо; очереди для фоновых задач и RTC-сессий).
- **Доменные события**: Postgres Outbox (`event_outbox`) + фоновые воркеры; DLQ ведётся в `event_outbox_failures`. Kafka/другие брокеры подключаются только после явно одобренного roadmap.
- **API**: REST с OpenAPI 3.1 ИЛИ tRPC; одно из двух должно быть задокументировано и проверяемо.

## 4. Сервисы и их границы ответственности

- `auth`: аутентификация (JWT/refresh), авторизация (RBAC), управление сессиями.
- `diagnostics`: сбор и хранение диагностических данных, тестовые протоколы.
- `route-orchestrator`: формирование и управление коррекционными маршрутами.
- `exercises`: упражнения/контент, трекинг выполнения, хранение артефактов в S3.
- `assignments`: назначения упражнений, SLA по выполнению, уведомления.
- `templates`: маршрутные/оценочные шаблоны и их публикация.
- `comms`: сообщения, уведомления, интеграции с мессенджерами/календарями.
- `reports`: отчёты, экспорт, шаблоны.
- `analytics`: агрегаты, метрики, витрины.
- `specialists`: профили специалистов, лицензии, привязка к маршрутам.
- `media/rtc`: медиа-сессии в реальном времени, хранение записей, сигнальный слой.
- `webhooks`: исходящие вебхуки, адаптеры внешних платформ.
- `security-compliance`: аудит, DSAR, ретеншн, политика соответствия.

Любое пересечение границ требует явного API-контракта. Прямое чтение чужих таблиц запрещено.

## 5. Данные и соответствие требованиям

- **Владение данными**: таблицами владеет один сервис; доступ — через его API.
- **PII/чувствительные данные**: минимизация, маскирование в логах, аудит доступа.
- **Retention (единая политика, см. `DATA_GOVERNANCE.md`)**:
  - Профили пользователей — срок действия договора + 1 год, затем псевдонимизация и архив.
  - Профили детей — пока активен маршрут + 5 лет хранения; после этого допускается только деперсонализированный архив.
  - Диагностические данные — минимум 5 лет; продление возможно только с явным согласием и юридическим основанием.
  - Коррекционные маршруты, назначения и отчёты — 5 лет (до 10 лет по запросам регуляторов/суда).
  - Журналы аудита и DSAR — 3 года с обязательной маскировкой идентификаторов при выгрузке.
  - Бэкапы — rolling 30 дней, шифрование и доступ по принципу наименьших привилегий.
  - Временные/кэш-данные — максимум 30 дней, автоочистка обязательна.
- **Миграции**: версия схемы инкрементальная; миграции атомарные и обратимые; тестирование на стейдже обязательно.

## 6. Контракты API и совместимость

- **REST**: спецификации OpenAPI 3.1 публикуются рядом с сервисом; проверки линтерами обязательны.
- **tRPC**: типобезопасные роутеры; договорённости о versioning (например, неймспейсы `v1`).
- **Версионирование**: мажорные изменения — только через новую версию API; старые версии поддерживаются ограниченное время с Deprecation-уведомлениями.

## 7. События и очереди

- **Транспорт**: Postgres Outbox в каждом сервисе (`event_outbox`), фоновые воркеры публикуют события в соответствии с контрактами; Kafka/другие брокеры подключаются только по roadmap-решению.
- **DLQ**: `event_outbox_failures` + алерты при превышении SLA доставки.
- **Именование**: `domain.eventName.v1`, версии повышаются только при breaking-изменениях payload.
- **Идемпотентность**: обработчики обязаны уметь повторно обрабатывать сообщение.
- **Dead-letter**: обязательные DLQ и алерты при превышении порогов ошибок.

## 8. Безопасность

- **Аутентификация**: JWT с короткоживущими access-токенами и refresh-механизмом; HttpOnly cookies или заголовки.
- **Авторизация**: RBAC; проверка ролей на границе BFF/сервиса.
- **Транспорт**: TLS обязателен вне локальной разработки.
- **Секреты**: только через переменные окружения/секрет-хранилища; запрет коммитить секреты.
- **Rate limiting**: на внешних границах и чувствительных эндпойнтах.
- **Аудит**: логирование ключевых действий пользователя и админа.

## 9. Наблюдаемость и качество

- **Логи**: структурированные, без PII; корреляция по trace/request id.
- **Метрики**: базовые (RPS, p95/p99 latency, ошибки), бизнес-метрики per сервис.
- **Трейсинг**: распределённые трассы для межсервисных вызовов (если применимо).
- **Тесты**: минимум unit + интеграционные для контрактов; для критичных потоков — e2e.

## 10. Производительность и SLO

- **Цели по задержкам**: p95 < 200ms для публичных API BFF; внутренние — < 100ms, если не оговорено иначе.
- **Надёжность**: целевой аптайм сервиса 99.9% (если не указано иначе).
- **Бюджеты**: размер ответов, время генерации отчётов, лимиты очередей — должны быть зафиксированы в планах.

## 11. Интеграции с внешними системами

- **Шлюз интеграций**: все внешние подключения идут через слой интеграций сервиса `comms` или специализированные адаптеры.
- **Протоколы**: вебхуки, OAuth2/OIDC, подписки/пулы — с ретраями и idempotency-keys.
- **Изоляция**: деградация внешнего провайдера не должна ломать ядро; таймауты/фолбэки обязательны.

## 12. Контейнеры и окружения

- **Локальная разработка**: выполняется исключительно внутри Docker/Compose-контейнеров; bare-metal запуск допускается только по согласованному исключению.
- **Тестирование**: unit, integration и e2e-прогоны локально и в CI выполняются в контейнерах с теми же базовыми образами, что и прод.
- **База данных**: если есть контейнер БД с рабочими данными, его **нельзя удалять**.
- **Обновления**: перед деплоем/миграциями — прогон на стейдж-окружении с теми же версиями образов.

## 13. Процесс разработки

- **Ветвление**: фичи создаются через `.specify/scripts/bash/create-new-feature.sh` (ветка `NNN-short-name`).
- **Спеки/планы**: для каждой фичи — `specs/NNN-*/spec.md`, затем `plan.md`, `contracts/`, `tasks.md`.
- **Документация**: любые изменения SoT и связанных артефактов проходят процесс из `Documents/DOCUMENTATION_UPDATE_GUIDELINE.md` (инициация → согласование владельца → обновление версий/таблицы статусов → Constitution Check → ревью → коммуникация в каналах).
- **Definition of Done**: пройдены все gates, тесты зелёные, документация обновлена.

## 14. Конституционные GATES (обязательные проверки)

Каждый план должен явно отметить прохождение пунктов ниже:

- [ ] **Stack Compliance**: используются разрешённые технологии (Next.js/TS, PostgreSQL, MinIO, Redis, REST/tRPC).
- [ ] **Service Boundaries**: определены владелец данных и границы; нет прямого доступа к чужим таблицам.
- [ ] **API Contract**: есть OpenAPI 3.1 или tRPC-роутер; указано версионирование и совместимость.
- [ ] **Events**: задокументированы публикуемые/подписываемые события, названы по конвенции, продуман DLQ.
- [ ] **Security Baseline**: аутентификация/авторизация, секреты, TLS, rate limiting — описаны и реализуемы.
- [ ] **Data Policy**: PII-правила, ретеншн, миграции и обратимость — зафиксированы.
- [ ] **Observability**: логи, метрики, трассировка (если нужно) — описаны.
- [ ] **Performance/SLO**: цели по p95/ошибкам/бюджетам определены и достижимы.
- [ ] **Integration Isolation**: внешние зависимости оформлены через адаптеры с таймаутами/ретраями.
- [ ] **Containers Policy**: план обновлений учитывает наличие тестовых контейнеров; БД-контейнер не удаляется.

## 15. Исключения из правил

Допускаются только при явном обосновании в разделе "Complexity Tracking" плана:

- описание нарушения; зачем нужно; какие более простые альтернативы были отвергнуты.
- срок и план возврата к стандарту.

---

Последнее обновление: 2025-10-31
